-- Load WindUI
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

-- Window
local Window = WindUI:CreateWindow({
    Title = "PVP Script (test)",
    Icon = "user",
    Author = "https://discord.gg/AXTKtmUvyf",
    OpenButton = {
        Title = "Felon HUB",
        Icon = "sword",
        Enabled = true,
        Draggable = true,
    }
})

local Main = Window:Tab({
    Title = "Main",
    Icon = "star",
})

Main:Section({ Title = " Player Settings " })

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local orbitConnection = nil

-- ฟังก์ชันหาคนใกล้ที่สุด
local function getClosest()
    local target = nil
    local dist = math.huge
    for _, v in pairs(Players:GetPlayers()) do
        if v ~= lp and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
            local magnitude = (lp.Character.HumanoidRootPart.Position - v.Character.HumanoidRootPart.Position).Magnitude
            if magnitude < dist then
                dist = magnitude
                target = v
            end
        end
    end
    return target
end

-- สำหรับ Wind UI โครงสร้างจะเป็นแบบนี้:
Main:AddToggle({
    Title = "Orbit Nearest Player",
    Desc = "วาร์ปไปลอยวนบนหัวคนที่ใกล้ที่สุด",
    Value = false, -- ค่าเริ่มต้น
    Callback = function(v)
        if v then
            -- ถ้ามีงานเก่าค้างอยู่ให้ปิดก่อนเพื่อกันซ้อน
            if orbitConnection then orbitConnection:Disconnect() end
            
            orbitConnection = RunService.Heartbeat:Connect(function()
                -- ใช้ pcall ครอบไว้กันสคริปต์หลุดเวลาคนที่เราตามกดรีเซ็ตตัวละคร
                pcall(function()
                    local target = getClosest()
                    if target and target.Character and lp.Character then
                        local root = lp.Character:FindFirstChild("HumanoidRootPart")
                        local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
                        
                        if root and targetRoot then
                            local t = tick() * 4 -- ความเร็วในการหมุน (ปรับเลข 4 ได้)
                            local radius = 6 -- ระยะห่างวงกลม
                            local height = 5 -- ความสูงเหนือหัว
                            
                            -- คำนวณตำแหน่งใหม่
                            local orbitPos = targetRoot.Position + Vector3.new(math.sin(t) * radius, height, math.cos(t) * radius)
                            
                            -- วาร์ปและหันหน้าไปหาเป้าหมาย
                            root.CFrame = CFrame.new(orbitPos, targetRoot.Position)
                        end
                    end
                end)
            end)
        else
            -- เมื่อกดปิด
            if orbitConnection then
                orbitConnection:Disconnect()
                orbitConnection = nil
            end
        end
    end
})
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- การตั้งค่าเบื้องต้น
local AimSettings = {
    Enabled = false,
    FovSize = 150,
    FovColor = Color3.fromRGB(255, 255, 0), -- สีเหลือง
    Thickness = 1,
    Smoothing = 0.5 -- ความสมูท (0-1) ยิ่งน้อยยิ่งเลื่อนเร็ว
}

-- สร้างวงกลม FOV
local FOVCircle = Drawing.new("Circle")
FOVCircle.Visible = false
FOVCircle.Color = AimSettings.FovColor
FOVCircle.Thickness = AimSettings.Thickness
FOVCircle.Transparency = 1
FOVCircle.Filled = false
FOVCircle.Radius = AimSettings.FovSize

-- ฟังก์ชันหาตัวละครที่ใกล้เป้า (Mouse) ที่สุดใน FOV
local function getClosestPlayerToMouse()
    local target = nil
    local dist = AimSettings.FovSize

    for _, v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and v.Character and v.Character:FindFirstChild("HumanoidRootPart") and v.Character:FindFirstChild("Humanoid").Health > 0 then
            local screenPos, onScreen = Camera:WorldToViewportPoint(v.Character.HumanoidRootPart.Position)
            if onScreen then
                local mouseDistance = (Vector2.new(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y) - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                if mouseDistance < dist then
                    dist = mouseDistance
                    target = v
                end
            end
        end
    end
    return target
end

-- อัปเดตวงกลม FOV ตามเมาส์ตลอดเวลา
RunService.RenderStepped:Connect(function()
    FOVCircle.Position = UserInputService:GetMouseLocation()
    
    if AimSettings.Enabled then
        local target = getClosestPlayerToMouse()
        if target then
            local targetPos = Camera:WorldToViewportPoint(target.Character.HumanoidRootPart.Position)
            local mousePos = UserInputService:GetMouseLocation()
            -- ระบบช่วยเล็ง (Smoothing)
            Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(Camera.CFrame.Position, target.Character.HumanoidRootPart.Position), AimSettings.Smoothing)
        end
    end
end)

-- เพิ่มเข้าไปใน Wind UI
Main:AddToggle({
    Title = "Aimbot + FOV",
    Desc = "ล็อคเป้าหมายอัตโนมัติ (เส้นสีเหลือง)",
    Value = false,
    Callback = function(v)
        AimSettings.Enabled = v
        FOVCircle.Visible = v
    end
})

-- (Optional) Slider ปรับขนาด FOV
Main:AddSlider({
    Title = "FOV Size",
    Min = 50,
    Max = 500,
    Default = 150,
    Callback = function(v)
        AimSettings.FovSize = v
        FOVCircle.Radius = v
    end
})
